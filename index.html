<!DOCTYPE html>
<html lang="ja">
  <head>
    <title>Pokemon Data - KMeans Clustering</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" type="text/css" />
    <link rel="stylesheet" href="https://unpkg.com/@holoviz/panel@0.13.1/dist/css/widgets.css" type="text/css" />
    <link rel="stylesheet" href="https://unpkg.com/@holoviz/panel@0.13.1/dist/css/markdown.css" type="text/css" />

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-2.4.2.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-2.4.2.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-2.4.2.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/@holoviz/panel@0.13.1/dist/panel.min.js"></script>
    <script type="text/javascript">
      Bokeh.set_log_level("info");
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/@holoviz/panel@0.13.1/dist/bundled/bootstraptemplate/bootstrap.css">
    <link rel="stylesheet" href="https://unpkg.com/@holoviz/panel@0.13.1/dist/bundled/defaulttheme/default.css">

    <style>
      #sidebar {
	  width: 350px;
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <link rel="stylesheet" href="./assets/css/examples.css" />
  </head>

  <body>
    <nav class="navbar" style="background-color: #000000;">
      <div class="app-header">
        <a class="title" href="" style="color: #e43cf0;">Pokemon Data - KMeans Clustering</a>
      </div>
    </nav>
    <section class="pyscript">
      <div class="row overflow-hidden" id="content">
	      <div class="sidenav" id="sidebar">
          <ul class="nav flex-column">
                  <div class="bk-root" id="x-widget"></div>
                  <div class="bk-root" id="y-widget"></div>
                  <div class="bk-root" id="n-widget"></div>
          </ul>
        </div>
        <div class="col mh-100 float-left" id="main">
          <div class="bk-root" id="cluster-plot"></div>
          <div class="bk-root" id="table"></div>
        </div>
      </div>
      <py-tutor>
        <py-config>
          packages = [
            "altair",
            "numpy",
            "pandas",
            "scikit-learn",
            "panel==0.13.1"
          ]
        </py-config>

        <py-script>
          import altair as alt
          import panel as pn
          import pandas as pd
          from sklearn.cluster import KMeans
          from pyodide.http import open_url

          pn.config.sizing_mode = 'stretch_width'

          url = 'https://raw.githubusercontent.com/ranran1212/pyscript_pokemon/main/pokemon.csv'
          penguins = pd.read_csv(open_url(url)).dropna()
          cols = list(penguins.columns)[3:8]

          x = pn.widgets.Select(name='x', options=cols, value='こうげき').servable(target='x-widget')
          y = pn.widgets.Select(name='y', options=cols, value='ぼうぎょ').servable(target='y-widget')
          n_clusters = pn.widgets.IntSlider(name='クラスタ数', start=1, end=5, value=3).servable(target='n-widget')

          brush = alt.selection_interval(name='brush')  # selection of type "interval"

          def get_clusters(n_clusters):
              kmeans = KMeans(n_clusters=n_clusters)
              est = kmeans.fit(penguins[cols].values)
              df = penguins.copy()
              df['クラスタ'] = est.labels_.astype('str')
              return df

          def get_chart(x, y, df):
              centers = df.groupby('クラスタ').mean()
              return (
                  alt.Chart(df)
                      .mark_point(size=100)
                      .encode(
                          x=alt.X(x, scale=alt.Scale(zero=False)),
                          y=alt.Y(y, scale=alt.Scale(zero=False)),
                          color=alt.Color('タイプ1', legend=alt.Legend(orient="right",direction="vertical")),
                          shape=alt.Color('タイプ2', legend=alt.Legend(orient="right",direction="vertical")),
                          tooltip=['No','名前','タイプ1','タイプ2','クラスタ']
                      ).add_selection(brush).properties(width=800,height=600) +
                  alt.Chart(centers)
                      .mark_point(size=250, shape='cross', color='black')
                      .encode(x=x+':Q', y=y+':Q')
              )
          chart = pn.pane.Vega().servable(target='cluster-plot')
          table = pn.widgets.Tabulator(pagination='remote', page_size=25).servable(target='table')

          def update_table(event=None):
              table.value = get_clusters(n_clusters.value)

          n_clusters.param.watch(update_table, 'value')

          @pn.depends(x, y, n_clusters, watch=True)
          def update_chart(*events):
              chart.object = get_chart(x.value, y.value, table.value)
              chart.selection.param.watch(update_filters, 'brush')

          def update_filters(event=None):
              filters = []
              for k, v in (getattr(event, 'new') or {}).items():
                  filters.append(dict(field=k, type='>=', value=v[0]))
                  filters.append(dict(field=k, type='<=', value=v[1]))
              table.filters = filters

          update_table()
          update_chart()
        </py-script>
     </py-tutor>
    </section>
  </body>
</html>
